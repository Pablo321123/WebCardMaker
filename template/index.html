<!DOCTYPE html>
<html>

<head>
  <title>Naruto Card Maker </title>
  <meta charset="UTF-8">
  <link rel="icon" href="villages/leaf.png" type="image/png">
</head>

<body>

  <div class="container">

    <div class="imgTemplate">
      <canvas id="myCanvas" style="width: 343px; height: 500px;">
    </div>

    <button id="btnImgDowload"><a id="imagePreview"></a>Download</button>

    <div class="title-conteiner">

      <div class="txtForm">
        <input type="text" name="" id="title-card" placeholder="Título">
        <input type="text" name="" id="subtitle-card" placeholder="Tags">
        <input type="number" name="" id="level-card" placeholder="Nível">
      </div>

      <div class="villages-conteiner">
        <div class="villages">
          <select name="" id="select-villages">
            <option value="">Vila</option>
            <option value="cloud">Nuvem</option>
            <option value="leaf">Folha</option>
            <option value="mist">Água</option>
            <option value="rain">Chuva</option>
            <option value="rock">Pedra</option>
            <option value="sand">Areia</option>
            <option value="sound">Som</option>
          </select>
          <div class="type-villages">
            <select name="" id="select-type-villages">
              <option value="normal">Normal</option>
              <option value="aka">Aka</option>
            </select>
          </div>
        </div>
      </div>
    </div>


    <div class="card-types">
      <select name="" id="select-type-card">
        <option value="shinobi">Ninja</option>
        <option value="jutsu">Jutsu</option>
        <option value="mission">Missão</option>
        <option value="client">Cliente</option>
      </select>
    </div>

    <div class="desc-container">

      <div class="effect-container">
        <input type="text" name="" id="effect-title" placeholder="Título do Efeito">
        <textarea name="" id="effect-desc" cols="30" rows="2" placeholder="Descrição do Efeito"></textarea>
      </div>

    </div>


  </div>


  <script>
    //Fonts
    const AlenconDemo = new FontFace('AlenconDemoFamily', 'url(Allencon_Demo/Allencon-Demo.woff)')
    const TrebuchetMS = new FontFace('TrebuchetMSFamily', 'url(Trebuchet_MS/trebuc.woff)')
    const TrebuchetMSBold = new FontFace('TrebuchetMSBold', 'url(Trebuchet_MS/trebuchet_ms_bold.ttf)')
    document.fonts.add(AlenconDemo)
    document.fonts.add(TrebuchetMS)
    document.fonts.add(TrebuchetMSBold)

    //selects
    const selectCardType = document.getElementById('select-type-card')

    const selectVillage = document.getElementById('select-villages')
    const selectVillageType = document.getElementById('select-type-villages')

    // Obtendo uma referência para o botão pelo id
    const titleText = document.getElementById('title-card')
    const subtitleText = document.getElementById('subtitle-card')
    const levelText = document.getElementById('level-card')
    const effectTitleText = document.getElementById('effect-title')
    const effectDescTextA = document.getElementById('effect-desc')

    const btnDowload = document.getElementById('btnImgDowload');
    const btnUpdateText = document.getElementById('btnAtualizaTexto');

    var canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d', { alpha: true });

    // Carrega a imagem
    var img = new Image();
    img.src = 'BGCard.png';
    img.onload = function () {
      loadBGImage()
    };

    var upLine = new Image()
    upLine.src = 'lines/faixa_de_cima.png'

    var downLine = new Image()
    downLine.src = 'lines/faixa_de_baixo.png'

    var levelBG = new Image()
    levelBG.src = 'nv_symbol.png'

    canvas.width = img.width;
    canvas.height = img.height;

    const x = canvas.width / 2
    const y = canvas.height / 2

    const dicVillageImg = {}
    loadImgVillages()

    function calcTextSize(text) {
      const textMetrics = ctx.measureText(text);
      ////console.log(textMetrics)

      return textMetrics
    }

    function calcCenterImg(image) {

      const x_img = x - (image.width / 2)
      const y_img = y - (image.height / 2)

      return [x_img, y_img]
    }

    function loadBGImage() {

      // Cria o canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      ctx.drawImage(img, 0, 0);

      // Write Title, SubTitle, Jutsus Skills and Atributtes
      writeInCanva()

      //Lines
      drawLines()

      //Card Level
      if (levelText.value != '') {
        drawLevelCard()
      }

      if ((selectCardType.value != 'mission')) {
        drawVillage()
      }

    }

    function drawLines() {
      ctx.drawImage(upLine, (upLine.width - x) / 4, y + 110)
      //console.log('Desenhando linha de cima...')

      /*ctx.strokeStyle = "#8d313d";
          ctx.moveTo(70, y + 110);
          ctx.lineTo((x * 2) - 70, y + 110);
          ctx.stroke();*/
    }

    function chooseTypeCard() {
      var textTitleEffect = ''

      if (['client', 'shinobi'].includes(selectCardType.value)) {
        textTitleEffect = `[${effectTitleText.value}]: `
      } else if (selectCardType.value === 'mission') {
        textTitleEffect = 'Efeito: '
      } else {
        textTitleEffect = 'Requisitos: ' //Alterar
      }

      return textTitleEffect
    }

    function searchSpecialWords(line, x, y, NR, VR) {

      var groupSpecial = []
      groupNegrito = line.match(/\{\*(.*?)\*\}/g); //ER para capturar o token
      groupVermelho = line.match(/\{~(.*?)~\}/g); //ER para capturar o token

      if (groupNegrito == null) {
        groupSpecial = groupVermelho
      } else if (groupVermelho == null) {
        groupSpecial = groupNegrito
      } else {
        groupSpecial = groupNegrito.concat(groupVermelho)
      }

      var groupWords = line.split(' ')

      var specialText = ''

      for (var i = 0; i < groupWords.length; i++) {
        word = groupWords[i]
        token = word.substring(0, 3)
        if ((token === NR || token === VR) && (groupSpecial != null)) {
          for (var j = 0; j < groupSpecial.length; j++) {
            special = groupSpecial[j]
            if (special != null) {
              if (special.includes(word)) {
                specialSize = special.split(' ').length
                i += (specialSize) > 1 ? specialSize - 1 : 0
                //console.log(specialSize)

                if (special.includes(NR)) {
                  ctx.font = 'bold 20px TrebuchetMSFamily'
                  ctx.fillStyle = 'black'
                } else {
                  ctx.font = '20px TrebuchetMSFamily'
                  ctx.fillStyle = '#8d313d'
                }
                specialText = special.substring(3, special.length - 3)
                ctx.fillText(specialText, x, y);
                x += calcTextSize(`${specialText} `).width
                break
              }
            } else {
              continue
            }
          }
        } else {
          ctx.font = '20px TrebuchetMSFamily'
          ctx.fillStyle = 'black'
          ctx.fillText(word, x, y);
          x += calcTextSize(`${word} `).width
        }
      }
    }

    function printAtWordWrap(text, x, y, lineHeight, fitWidth, initialLineWidth) {

      //var w = calcTextSize(str).width + (currentLine == 0 ? initialLineWidth : 0)
      // 
      //ctx.fillText(words.slice(0, idx - 1).join(' '), currentLine == 0 ? x : 50, y + (lineHeight * currentLine));

      // Personalização do texto
      const NR = '{*}'
      const VR = '{~}'

      //Contador de linha
      var currentLine = 0

      // Variavel Texto
      var lineText = ''
      var lines = []
      var tamLine = 0

      for (let i = 0; i < text.length; i++) {
        const caractere = text.charAt(i);

        lineText += caractere
        tamLine = calcTextSize(lineText).width

        ////console.log(`tamLine:${tamLine} >= fitWidth:${fitWidth}`)

        if (tamLine >= fitWidth - 50) {
          lastSpace = lineText.lastIndexOf(' ')
          lineText = lineText.substring(0, lastSpace) + '\n' + lineText.substring(lastSpace + 1)
          lines.push(lineText)
          lineText = ''
        }
      }

      lines.push(lineText)

      lineText = lines.splice(0).join('')
      lineText = lineText.split('\n')
      //console.log(lineText);

      for (line of lineText) {
        currentLine = lineText.indexOf(line)

        //console.log(line)
        if ((line.indexOf(NR) >= 0) || (line.indexOf(VR) >= 0)) {
          searchSpecialWords(line, currentLine == 0 ? x : 50, y + (lineHeight * currentLine), NR, VR)
          continue
        }

        ctx.font = '20px TrebuchetMSFamily'
        ctx.fillText(line, currentLine == 0 ? x : 50, y + (lineHeight * currentLine));
      }
    }

    function writeInCanva() {
      AlenconDemo.load().then(
        () => {
          //console.log(`AlenconDemoFamily: ${AlenconDemo.status}`)

          ctx.font = '65px AlenconDemoFamily'
          ctx.fillStyle = 'black';
          ctx.textAlign = "center"
          ctx.fillText(titleText.value, x, y + 90);

        }, (err) => {
          //console.error(err);
        })

      TrebuchetMS.load().then(
        () => {
          //console.log(`TrebuchetMSFamily: ${TrebuchetMS.status}`)

          //Subtitle Tags
          ctx.font = '600 20px TrebuchetMSFamily'
          ctx.fillStyle = '#8d313d'
          ctx.textAlign = "left"
          ctx.fillText(subtitleText.value, 70, y + 131);

        }, (err) => {
          //console.error(err);
        })

      //effect-title
      TrebuchetMS.load().then(
        () => {
          //console.log(`TrebuchetMSFamily: ${TrebuchetMS.status}`)

          const textTitleEffect = chooseTypeCard()

          //Subtitle Tags
          ctx.font = 'Bold 25px TrebuchetMSFamily'
          ctx.fillStyle = 'black'
          ctx.textAlign = "left"
          ctx.fillText(textTitleEffect, 50, y + 170);

        }, (err) => {
          //console.error(err);
        })


      //effect-desc
      TrebuchetMS.load().then(
        () => {
          //console.log(`TrebuchetMSFamily: ${TrebuchetMS.status}`)

          const textTitleEffect = chooseTypeCard()
          effectTitleSize = calcTextSize(textTitleEffect)


          /* if (['client', 'shinobi'].includes(selectCardType.value)) {
             textTitleEffect = `[${effectTitleText.value}]:`
           } else if (selectCardType.value === 'mission') {
             textTitleEffect = 'Efeito:'
           } else {
             textTitleEffect = 'Requisitos:' //Alterar
           }*/

          //Subtitle Tags
          ctx.font = 'bold 20px TrebuchetMSFamily'
          ctx.fillStyle = 'black'
          ctx.textAlign = "left"
          printAtWordWrap(effectDescTextA.value, effectTitleSize.width + 50, y + 170, 25, 700, effectTitleSize.width)
          //ctx.fillText(effectDescTextA.value, effectTitleSize.width + 50, y + 160); //50 é margem inicial

        }, (err) => {
          //console.error(err);
        })
    }

    function drawLevelCard() {

      //console.log('Writing Level Card...')
      coord_img = calcCenterImg(levelBG)

      ctx.drawImage(levelBG, (coord_img[0] + 280), (coord_img[1] + 58))

      TrebuchetMSBold.load().then(
        () => {
          //console.log(`TrebuchetMSBold: ${TrebuchetMSBold.status}`)

          ctx.font = 'Bold 60px TrebuchetMSBold'
          ctx.lineWidth = 3
          ctx.strokeStyle = 'black'
          ctx.fillStyle = 'white'
          ctx.textAlign = 'center'
          ctx.fillText(levelText.value, (x + 280), y + 90)
          ctx.strokeText(levelText.value, (x + 280), y + 90)

        }, (err) => {
          //console.error(err);
        })



    }

    function loadImgVillages() {
      const optionsVillage = selectVillage.options
      const listVillages = []

      for (const village of optionsVillage) {
        listVillages.push(village.value)
      }

      for (const village of listVillages) {
        ////console.log(listVillages);
        imgVillage = new Image()
        imgAkaVillage = new Image()
        imgVillage.src = `villages/${village}.png`
        imgAkaVillage.src = `villages/aka_${village}.png`
        //ctx.drawImage(imgVillage, 0, 0);

        dicVillageImg[village] = imgVillage
        dicVillageImg[`aka_${village}`] = imgAkaVillage
        //listVillageImg.push(imgVillage)
      }
      //listVillageImg.splice(0, 1)
      delete dicVillageImg[""]
      delete dicVillageImg["aka_"]

      dicVillageImg['aka_cloud'] = `villages/cloud.png`

      ////console.log(dicVillageImg)
    }

    function typesVillages(typeVillage) {

      var villageImg = new Image()

      switch (selectVillageType.value) {

        case 'aka':
          villageImg = dicVillageImg[`aka_${typeVillage}`]
          //console.log(dicVillageImg)
          imgCoord = calcCenterImg(villageImg)
          ctx.drawImage(villageImg, imgCoord[0] - 280, imgCoord[1] + 80);
          break;

        default:
          villageImg = dicVillageImg[typeVillage]
          imgCoord = calcCenterImg(villageImg)
          ctx.drawImage(villageImg, imgCoord[0] - 280, imgCoord[1] + 80);
          break;
      }
    }

    function drawVillage() {
      if (selectVillage.value != '') {
        typesVillages(selectVillage.value)
      }
    }

    // Adicionando um ouvinte de evento de clique ao botão
    btnDowload.addEventListener('click', function () {
      // Faz o download da imagem
      ////console.log(titleText.value)
      var link = document.getElementById('imagePreview');
      link.download = canvas.toDataURL('image/jpeg');
      link.href = link.download
      link.click()

    });

    titleText.addEventListener('input', () => loadBGImage())
    subtitleText.addEventListener('input', () => loadBGImage())
    levelText.addEventListener('input', () => loadBGImage())
    effectTitleText.addEventListener('input', () => loadBGImage())
    effectDescTextA.addEventListener('input', () => loadBGImage())

    selectVillage.addEventListener('change', () => loadBGImage())
    selectVillageType.addEventListener('change', () => loadBGImage())
    selectCardType.addEventListener('change', () => loadBGImage())

  </script>
</body>

</html>